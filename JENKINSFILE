pipeline {
  agent any

  stages {
    stage('Get Code') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: '*/develop']],
          userRemoteConfigs: [[
            url: 'git@github.com:PabloBin/todo-list-aws.git',
            credentialsId: 'github-deploykey'
          ]]
        ])
        sh 'echo "Branch:" && git branch -a --contains HEAD'
        sh 'echo "Last commit:" && git log -1 --oneline'
      }
    }
    stage('Static Test') {
      stages {
    
        stage('Static - Flake8') {
          steps {
            sh '''
              set -eux
              python3 -m venv .venv
              . .venv/bin/activate
              pip install --upgrade pip
              pip install flake8
    
              mkdir -p reports
              flake8 --exit-zero src > reports/flake8.out
            '''
            recordIssues(
              tools: [flake8(name: 'Flake8', pattern: 'reports/flake8.out')]
            )
          }
        }
    
        stage('Security - Bandit') {
          steps {
            sh '''
              set -eux
              python3 -m venv .venv
              . .venv/bin/activate
              pip install --upgrade pip
              pip install bandit
    
              mkdir -p reports
              bandit --exit-zero -r src \
                -f custom -o reports/bandit.out \
                --msg-template "{abspath}:{line}: [{test_id}] {msg}"
            '''
            recordIssues(
              tools: [pyLint(name: 'Bandit', pattern: 'reports/bandit.out')]
            )
          }
        }
      }
    }
  }
}
