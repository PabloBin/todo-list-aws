pipeline {
  agent any

  stages {
    stage('Get Code') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: '*/develop']],
          userRemoteConfigs: [[
            url: 'git@github.com:PabloBin/todo-list-aws.git',
            credentialsId: 'github-deploykey'
          ]]
        ])
        sh 'echo "Branch:" && git branch -a --contains HEAD'
        sh 'echo "Last commit:" && git log -1 --oneline'
      }
    }
       
    stage('Static Test') {
      steps {
        sh '''
          set -eux
    
          # 1) VENV reutilizable (evita reinstalar Python tools en cada build si el workspace se mantiene)
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi
          . .venv/bin/activate
          pip install --upgrade pip
    
          # 2) Instalar/actualizar herramientas dentro del venv
          pip install flake8 bandit
    
          # 3) Carpeta de reportes 
          mkdir -p reports
          # 4) Solo borramos los reportes de Flake8 y Bandit
          rm -f reports/flake8.out reports/bandit.out
    
          # 5) Flake8 (solo src, no bloqueante, salida estándar a fichero)
          flake8 --exit-zero src > reports/flake8.out
    
          # 6) Bandit (solo src, no bloqueante, salida “custom” para que pyLint lo pinte)
          bandit --exit-zero -r src \
            -f custom -o reports/bandit.out \
            --msg-template "{abspath}:{line}: [{test_id}] {msg}"
        '''
    
        // Publicación de resultados en Jenkins (sin quality gates => build SUCCESS siempre)
        recordIssues(tools: [flake8(name: 'Flake8', pattern: 'reports/flake8.out')])
        recordIssues(tools: [pyLint(name: 'Bandit', pattern: 'reports/bandit.out')])
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          set -eux
    
          # Verificar que hay credenciales en la EC2
          aws sts get-caller-identity
    
          sam --version
    
          sam build
    
          # Deploy no interactivo usando el config-env staging
          sam deploy \
            --config-env staging \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset
        '''
      }
    }

  }
}
