pipeline {
  agent any

  stages {
    stage('Get Code') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: '*/develop']],
          userRemoteConfigs: [[
            url: 'git@github.com:PabloBin/todo-list-aws.git',
            credentialsId: 'github-deploykey'
          ]]
        ])
        sh 'echo "Branch:" && git branch -a --contains HEAD'
        sh 'echo "Last commit:" && git log -1 --oneline'
      }
    }
    stage('Static - Flake8') {
      steps {
        sh '''
          set -eux
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install flake8
          
          echo "PWD=$(pwd)"
          echo "Listing src:"
          ls -la src || true
          echo "Flake8 version:"
          flake8 --version

          mkdir -p reports
          flake8 --exit-zero src > reports/flake8.out
          wc -l reports/flake8.out || true
          ls -la reports/flake8.out
        '''
        recordIssues(
          tools: [flake8(name: 'Flake8', pattern: 'reports/flake8.out')],
          qualityGates: [[threshold: 1, type: 'TOTAL', unstable: true]]
        )
      }
    }
  }
}
